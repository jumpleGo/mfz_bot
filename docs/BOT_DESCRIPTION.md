# Полное описание работы бота MoneyFlowZen

## Общее назначение
Telegram-бот для продажи платных подписок на закрытый канал. Использует **Firebase Realtime Database** для хранения данных.

## Основные функции

### 1. Регистрация пользователей
- При команде `/start` пользователь сохраняется в `bot_users/`
- Хранятся: `userId`, `username`, `firstName`, `lastName`, `languageCode`, дата регистрации

### 2. Покупка подписки
- **Выбор тарифа** — тарифы загружаются из `tariffsFotPayment/` в Firebase
- **Выбор срока** — каждый тариф имеет варианты (1/3/6/12 месяцев) с разными ценами и скидками
- **Выбор метода оплаты** — поддерживаются **Bybit UID** и **USDT** (из `paymentData/`)
- **Создание платежа** — генерируется уникальный ID (nanoid), статус `pending`
- **Загрузка чека** — пользователь отправляет скриншот оплаты
- **Проверка админом** — админ получает уведомление с чеком и кнопками "Подтвердить/Отклонить"

### 3. Выдача доступа
- При подтверждении платежа создаётся **одноразовая invite-ссылка** на канал (действует 24 часа)
- Ссылка автоматически отзывается через **30 минут** или по команде `/joined`
- Сохраняется дата окончания подписки

### 4. Продление подписки
- Если у пользователя есть активная подписка, новая покупка **продлевает** существующую (а не создаёт новую)
- Дата окончания увеличивается на купленный срок

### 5. Управление подписками
- **Моя подписка** — показывает активную подписку, дату окончания, оставшиеся дни

## Автоматические проверки (фоновые задачи)

| Проверка | Интервал | Описание |
|----------|----------|----------|
| Истекшие подписки | 6 часов | Удаляет пользователей из канала при истечении подписки |
| Уведомления об истечении | 1 час | Отправляет напоминания за **2 дня** и **8 часов** до окончания |
| Просроченные платежи | 15 минут | Отменяет неоплаченные платежи старше **1 часа** |

## Очередь сообщений (массовые рассылки)
- Слушает `message_queue/` в Firebase
- Поддерживает рассылку:
  - Всем пользователям
  - Только с активной подпиской
  - Только без подписки
  - Конкретному списку пользователей
- Защита от rate-limit: задержка 100мс между сообщениями

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Главное меню |
| `/joined` | Подтверждение входа в канал (отзыв ссылки) |
| `/check_channel` | Диагностика доступа к каналу (только админ) |

## Переменные окружения (.env)

| Переменная | Описание |
|------------|----------|
| `TELEGRAM_BOT_TOKEN` | Токен бота |
| `ADMIN_TELEGRAM_ID` | ID администратора |
| `CHANNEL_ID` | ID закрытого канала (начинается с -100) |
| Firebase credentials | Данные для подключения к Firebase |

## Структура данных в Firebase

| Путь | Описание |
|------|----------|
| `tariffsFotPayment/` | Тарифы с вариантами и ценами |
| `paymentData/` | Реквизиты для оплаты (Bybit UID, USDT) |
| `payments/` | Все платежи с историей и статусами |
| `bot_users/` | Зарегистрированные пользователи |
| `message_queue/` | Очередь массовых рассылок |

## Статусы платежей

| Статус | Описание |
|--------|----------|
| `pending` | Ожидает оплаты/проверки |
| `payed` | Оплачен и подтверждён |
| `cancelled` | Отменён пользователем или автоматически |
| `rejected` | Отклонён администратором |
| `expired` | Подписка истекла |

## Файловая структура проекта

```
mfz_bot/
├── bot.js                 # Основной файл бота
├── config/
│   └── firebase.js        # Конфигурация Firebase
├── services/
│   ├── tariffService.js   # Работа с тарифами
│   ├── paymentService.js  # Работа с платежами и подписками
│   ├── userService.js     # Работа с пользователями
│   ├── messageQueueService.js # Массовые рассылки
│   └── reminderService.js # Напоминания (не используется)
├── utils/
│   ├── keyboards.js       # Inline-клавиатуры
│   └── dateUtils.js       # Утилиты для работы с датами
└── docs/
    └── BOT_DESCRIPTION.md # Этот файл
```
